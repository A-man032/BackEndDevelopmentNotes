# 连接

**笛卡尔积**：连接查询的结果集中包含一个表中的每一条记录与另一个表中的每一条记录相互匹配的组合。

注：如果连接的列不是主键，连接时会产生笛卡尔积，造成数据爆炸。

遇到的几个join，总结：

- **left join**和**left semi join**的区别：
  - **left semi join**:  returns only data from the left row source. 返回的结果集中**只包含左表**的数据。右表只能在**ON**子句中设置条件，**WHERE、SELECT**都不行。
  - left semi join只能查左表的信息，left join可以查全部的信息。
  - 对右表重复key的处理方式差异：left semi join在右表遇到重复key会跳过，left join会一直遍历。
- **left broadcase join**: Regular join are executed on a single cluster node. Broadcase join is an execution strategy of join that distributes the join over cluster nodes. 
- **left antisemi join**: Give only those rows in the left rowset that have **no matching** row in the right rowset.  

### 连接的过程

1. 选取驱动表，使用与驱动表相关的过滤条件，选取代价最低的单表访问方法来执行对驱动表的单表查询。
2. step 1中查询驱动表得到的结果集中的每一条记录，都分别到被驱动表中查找匹配的记录。

**总结**：

- 在两表的连接查询中，驱动表只需要访问一次，被驱动表可能需要访问多次。

### 内连接和外连接

针对两表连接查询，即使在被驱动表中没有匹配到记录，是否要把驱动表中的记录加入到结果集中，产生了内连接和外连接的概念。

- **内连接**：如果驱动表中的记录在被驱动表中找不到匹配的记录，则该条记录不会加入到最后的结果集中。
- **外连接**：如果驱动表中的记录在被驱动表中找不到匹配的记录，则该条记录仍然要加入到最后的结果集中。（没有匹配到的记录，对应的被驱动表记录的各个字段使用NULL填充）
  - 左外连接：左侧表为驱动表
  - 右外连接：右侧表为驱动表

注：内连接中ON子句和WHERE子句是等价的，所以内连接中不要求强制写明ON子句。

无论哪个表作为驱动表，两表连接产生的笛卡尔积肯定都是一样的。**所以对于内连接来说，驱动表和被驱动表是可以互换的；但左外连接和右外连接的驱动表和被驱动表不能轻易互换。**

### 连接的原理

#### 嵌套循环连接

如果有3个表进行连接，那么连接过程中的step 2得到的结果集就像是新的驱动表，然后第3个表就成了被驱动表，重复上述过程。（可以抽象理解为是3层for循环）

嵌套循环连接算法：每当我们从驱动表中得到了一条记录时，就根据这条记录立即到被驱动表中查询一次。如果得到了匹配的记录，就把组合后的记录发送给客户端，然后再到驱动表中获取下一条记录。这个过程将**重复执行**。

#### 使用索引加快连接速度

虽然访问被驱动表要好多次，但每次查询其实就相当于一次单表查询，所以可以利用索引来加快查询速度。

#### 基于块的嵌套循环连接

前提：当被驱动表的数据特别大，使用嵌套循环算法要对被驱动表访问许多次，但可能因为内存不足，被驱动表无法全部放到内存中。所以被驱动表的数据特别多而且不能使用索引进行访问时，相当于要从磁盘上读这个表好多次，这样I/O代价就非常大了。

**Join Buffer**（连接缓冲区）：在执行连接查询前申请的一块固定大小的内存。

加入Join Buffer的嵌套循环连接算法称为基于块的嵌套循环连接。

- 先把若干条驱动表结果集中的记录装在Join Buffer中，然后开始扫描被驱动表，每一条被驱动表的记录一次与Join Buffer中的多条驱动表记录进行匹配。由于匹配的过程都是在内存中完成的，可以显著减少被驱动表的I/O代价。

Join Buffer的大小可以通过启动选项或者系统变量join_buffer_size进行配置，默认大小为256KB，最小可以设置为128byte。

**优化对被驱动表的查询**时，最好是为被驱动表加上高效率的索引。如果实在不能使用索引，并且机器的内存比较大时，可以尝试调大join_buffer_size的值来对连接查询进行优化。
