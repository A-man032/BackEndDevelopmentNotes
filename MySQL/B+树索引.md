# B+树索引

前情提要：各个数据页可以组成一个双向链表，而每个数据页中的记录会按照主键值从小到大的顺序组成一个单向链表。每个数据页都会为存储在它里面的记录生成一个页目录，在通过主键查找某条记录的时候可以在页目录中使用二分法快速定位到对应的槽，然后再遍历该槽对应分组中的记录，即可快速找到指定的记录。

## 没有索引时的查找过程

**在一个页中查找：**

- 以主键为搜索条件：在页目录中使用二分法快速定位到对应的槽，然后再遍历该槽对应分组中的记录，即可快速找到指定的记录。
- 以其他列为搜索条件：因为数据页中没有以非主键列建立的页目录，所以无法通过二分法快速定位到相应的槽。只能从Infimum记录开始依次遍历单向链表中的每条记录，然后对比每条记录是否符合搜索条件。

**在很多页中查找：**

- 定位到记录所在的页。
- 从所在的页内查找相应的记录。

## 索引

索引的设计原则：

- 下一个数据页中的主键值必须大于上一页中的主键值。
- 给所有的页建立一个目录项。

### InnoDB中的索引方案

索引记录和用户记录在结构上相似，索引中的两列是主键和页号，可以沿用存储用户记录的数据页来存储索引。

record_type的值用来区分一条记录是普通用户记录还是索引。

- 0：普通用户记录
- 1：目录项记录（索引）
- 2：Infimum记录
- 3：Supremum记录

**目录项记录和普通用户记录的区别：**

- **record_type值不同**，目录项记录是1，普通用户记录是0。
- **列数不同**，目录项记录只有两列，主键值和页号；普通用户记录的列是自定义的。但都有InnoDB自己添加的隐藏列。
- **min_rec_flag值不同**，目录项记录是1，普通用户记录是0。
- 除此之外，没有什么区别。两者使用相同的数据页，页的组成结构也是一样的，都会为主键值生成Page Directory，从而在按照主键值进行查找时可以使用二分法来加快查询速度。

InnoDB使用**B+树**的数据结构存储这些目录项记录和普通用户记录。用户记录存放在B+树最底层的节点，其余用来存放目录项记录。

真实的环境下，一个页存放的记录数量是非常大的，假设所有存放用户记录的叶子节点所代表的的数据页可以存放100条用户记录，所有存放目录项记录的内节点所代表的数据页可以存放1,000条目录项记录，则：

- B+树只有1层，最多存放100条用户记录
- B+树有2层，最多能存放$1,000×100=100,000$条用户记录
- B+树有3层，最多能存放$1,000×1,000×100=100,000,000$条用户记录
- B+树有4层，最多能存放$1,000×1,000×1,000×100=100,000,000,000$条用户记录

所以在一般情况下，我们使用的B+树不会超过4层。

#### 聚簇索引

B+树本身就是一个索引，我们把具备以下两个特点的B+树称为聚簇索引：

- 使用**记录主键值的大小**进行记录和页的排序。
  - **页内的记录**按照主键值的大小顺序排成一个**单向链表**，页内的记录被划分成若干个组，每个组中主键值最大的记录在页内的偏移量会被当作槽依次存放在**页目录**中，可以在页目录中通过**二分法**快速定位到主键列等于某个值的记录。
  - **各个存放用户记录的页**也按照页中用户记录的主键大小顺序排成一个**双向链表**。
  - **存放目录项记录的页**分为不同的层级，在同一层级中的页也按照页中目录项记录的主键大小顺序排成一个**双向链表**。
- B+树的叶子节点存储的是完整的用户记录，即存储了所有列的值。

**所有完整的用户记录都存放在聚簇索引的叶子节点处。**InnoDB中，聚簇索引是数据的存储方式。“索引即数据，数据即索引”。

#### 二级索引（辅助索引）

**聚簇索引只能在搜索条件是主键值时才能发挥作用**，因为B+树中都是按照主键进行排序的。

那如果想以别的列作为搜索条件时，就需要用二级索引了。

二级索引B+树的特点，以c2列作为排序规则为例：

- 使用记录c2列的大小进行记录和页的排序。
  - 页内的记录按照c2列的大小顺序排成一个单向链表，页内的记录被划分成若干个组，每个组中c2列值最大的记录在页内的偏移量会被当作槽依次存放在页目录中，可以在页目录中通过二分法快速定位到c2列等于某个值的记录。
  - 各个存放用户记录的页也是根据页中记录的c2列的大小顺序排成一个双向链表。
  - 存放目录项记录的页分为不同的层级，在同一层级中的页也是根据页中的目录项记录的c2列大小顺序排成一个双向链表。
- **B+树的叶子节点存储的并不是完整的用户记录，只有c2列和主键两个列的值。**
- **目录项记录不再是主键+页号的搭配，而是c2列+页号的搭配。**

 二级索引的B+树中只存储了c2列和主键值的列，所以会涉及到**回表**操作，**回表是指通过携带主键信息到聚簇索引中重新定位完整的用户记录的过程。**

Q：为什么二级索引需要一次回表操作，而不是直接把完整的用户记录放到叶子节点中呢？

A：直接把用户记录存储到叶子节点虽然节省了查询时间，但是太浪费存储空间了。相当于每建立一棵B+树都要把用户记录复制一遍。

#### 联合索引

同时以多个列的大小作为排序规则，即**同时为多个列建立索引**。

B+树按照c2和c3列的大小进行排序：

- 先把各个记录和页按照c2列进行排序；
- 在记录的c2列相同的情况下，再采用c3列进行排序。

注意：

- 每条目录项记录由c2列、c3列、页号三部分组成。各条记录先按照c2列的值进行排序，如果记录的c2列相同，则按照c3列的值进行排序。
- B+树叶子节点处的用户记录由c2列、c3列、主键c1列组成。

**联合索引本质上也是一个二级索引，索引列是c2,、c3。**

Q：“以c2和c3列的大小为排序规则建立联合索引”和“分别为c2和c3列建立索引”，有何不同？

A：联合索引只会建立一棵B+树；为c2和c3列分别建立索引，则会分别建立以c2和c3列的大小为排序规则的两棵B+树。

### InnoDB中B+索引的注意事项

1. 根页面

   B+树的形成过程：

   - 每当为某个表创建一个B+树索引时，就会为这个索引创建一个根节点页面。最开始表中没有数据的时候，每个B+树索引对应的根节点中既没有用户记录，也没有目录项记录。
   - 向表中插入用户记录时，先把用户记录存储到根节点中。
   - 当根节点中的可用空间用完时再继续插入记录，此时根节点中的所有记录会复制到一个新分配的页中，然后对这个新页进行页分裂操作，得到另一个新页。**根节点此时升级为存储目录项记录的页**。

   **注意：根节点的页号自创建起就不会改变。**根节点的页号会存储到数据字典中，InnoDB使用这个索引时，会去数据字典中取根节点的页号来访问这个索引。

2. 内节点中目录项记录的唯一性

   B+树索引的内节点中，目录项记录的内容是索引列+页号的组合，但是对于二级索引来说，会有问题出现。

   对于二级索引的内节点来说，索引列的值并不是唯一的，可以是大量重复的（某一个索引列的值可能会对应好几页的数据），比如目录项中的索引记录（[索引列的值，页号]）时[1,4], [1,5]，那么当新插入的记录索引列的值也为1时，那是应该插入到第4页还是第5页呢？

   - 为保证新插入的记录能找到自己在哪一页，就需要保证**B+树同层次内节点的目录项记录除页号外是唯一的**。
   - 二级索引的内节点中目录项记录实际是由**索引列的值+主键值+页号**三部分组成。
   - **二级索引记录是先按照二级索引列的值进行排序，在二级索引列值相同的情况下，再按照主键值进行排序。**

3. 一个页面至少容纳2条记录

   B+树只需要很少的层级就可以轻松存储数亿条记录，查询速度特别快。这是因为B+树本质就是一个大的多层级目录，每经过一个目录时都会过滤掉许多无效的子目录，直到最后访问到存储真正数据的目录。

   如果让B+树的叶子节点只存储一条记录，让内节点存储多条记录，也可以发挥B+树的作用。但为避免B+树的层级增长过高，InnoDB要求所有数据页都至少可以容纳2条记录。

### MyISAM中的索引方案

InnoDB中索引即数据，聚簇索引的B+树的叶子节点中已经包含了完整的用户记录。**MyISAM的索引方案是将索引和数据分开存储的树形结构**。

- MyISAM将表中的记录**按照记录的插入顺序**单独存储到一个文件中（称为数据文件）。这个文件不会划分为若干数据页，可以通过**行号**快速访问到一条记录。**由于插入数据时并不是按照主键大小排序，所以不可以在数据上使用二分查找。**
- MyISAM的表会把索引信息单独存储到另一个文件中（称为索引文件）。**MyISAM为表的主键单独创建一个索引，只不过在索引的叶子节点中存储的不是完整的用户记录，而是主键值+行号的组合。**即先通过索引找到对应的行号，再通过行号去找对应的记录。**MyISAM需要进行一次回表操作**，MyISAM中建立的索引相当于全部都是二级索引。
- MyISAM也可以为其他列分别创建索引或者建立联合索引，原理与InnoDB中的索引差不多，只不过在叶子节点处存储的是**相应的列+行号**。这些索引也全部都是二级索引。

注意：MyISAM的行格式有定长记录格式、变长记录格式、压缩记录格式等。

- 如果使用定长记录格式，可以使用行号计算出记录在数据文件中的地址偏移量。
- 如果使用变长记录格式，MyISAM会直接在索引叶子节点处存储该条记录在数据文件中的地址偏移量。可以看出，MyISAM回表的速度特别快，因为它是直接拿着地址偏移量直接到文件中取数据，而InnoDB是通过获取主键之后再去聚簇索引中找记录，虽然也不慢，但不如直接用地址访问快。

InnoDB和MyISAM会自动为主键或者带有UNION属性的列创建索引，如果想要为其他列创建索引，就需要显示地指明了。

